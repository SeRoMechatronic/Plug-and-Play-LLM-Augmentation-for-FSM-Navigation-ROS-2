# Plug-and-Play LLM Augmentation of FSM Navigation (ROS 2)

**Summary** — This repository contains the code and data for a 50 Hz finite-state machine (FSM) navigation stack **augmented** with asynchronous, validated **LLM** suggestions (no fine-tuning), with a deterministic <5 ms fallback. It includes three ROS 2 nodes (FSM, LLM, Validator/Fusion), per-trial CSV datasets, analysis scripts, and trajectory figures for a 5×5 m Maze Arena (with “approach” markers: accepted ✅ / rejected ❌).

---

## Repository layout

```
.
├─ README.md                     # this file
├─ LICENSE
├─ environment.yml               # optional (conda)
├─ requirements.txt              # pip
├─ ros2_ws/
│  ├─ src/
│  │  ├─ fsm_nav/
│  │  │  ├─ fsm_nav/
│  │  │  │  ├─ __init__.py
│  │  │  │  └─ node.py                 # publishes /cmd_vel_base @ 50 Hz
│  │  │  ├─ package.xml
│  │  │  └─ setup.py
│  │  ├─ llm_sugg/
│  │  │  ├─ llm_sugg/
│  │  │  │  ├─ __init__.py
│  │  │  │  └─ node.py                 # publishes /llm_suggestion (JSON)
│  │  │  ├─ package.xml
│  │  │  └─ setup.py
│  │  ├─ validator_fusion/
│  │  │  ├─ validator_fusion/
│  │  │  │  ├─ __init__.py
│  │  │  │  └─ node.py                 # validates & fuses → /cmd_vel
│  │  │  ├─ package.xml
│  │  │  └─ setup.py
│  │  └─ llm_nav_bringup/
│  │     ├─ launch/
│  │     │  ├─ sim.launch.py
│  │     │  └─ real.launch.py
│  │     └─ package.xml
│  └─ install/                          # generated by colcon
├─ config/
│  ├─ params.yaml                       # fusion, limits, deadlines, topics
│  └─ qos.yaml                          # optional QoS profiles
├─ data/
│  ├─ llm_fsm_trials.csv                # per-trial dataset (sim+real, base+llm)
│  ├─ aggregate_by_condition.csv
│  ├─ stats_summary.csv
│  ├─ traj_sim.csv
│  └─ traj_real.csv
├─ figures/
│  ├─ traj_sim_overlay.png              # 5×5 overlays (approach markers)
│  └─ traj_real_overlay.png
├─ scripts/
│  ├─ analyze_stats.py                  # CI, significance tests, effect sizes
│  ├─ plot_figures.py                   # success/error/efficiency/latency + overlays
│  ├─ make_trajectories.py              # regenerate 5×5 trajectories & overlays
│  └─ bag_to_csv.py                     # optional rosbag2 → CSV stub
└─ docs/
   ├─ HOWTO_repro.md
   └─ CITATION.bib
```

> Place the CSVs under `data/` and figures under `figures/` exactly with those names for scripts and LaTeX to work out-of-the-box.

---

## Requirements

- **ROS 2** (Humble recommended), `colcon`, `rclpy`
- **Python ≥ 3.9**
- Python deps: `numpy`, `pandas`, `scipy`, `matplotlib`, `pydantic`, `pyyaml`, `transformers`, `torch` (CUDA optional)
- **Hardware (real)**: TurtleBot3 (Burger/Waffle), Intel RealSense D435i
- **GPU (optional)**: Jetson Orin / NVIDIA to accelerate DistilGPT-2 (not required)

### Install (pip)

```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
```

### Install (conda)

```bash
conda env create -f environment.yml
conda activate llm-fsm
```

---

## Configuration

Main settings live in `config/params.yaml`:

```yaml
fusion:
  alpha: 0.5                 # fusion weight (0=FSM only, 1=LLM only)
  v_min: 0.00                # m/s
  v_max: 0.35
  w_min: -1.2                # rad/s
  w_max: 1.2
  deadline_ms: 200           # late suggestions are discarded
  project_safe: true         # clamp to safe set

llm:
  model_name: distilgpt2
  max_new_tokens: 40
  temperature: 0.1
  top_p: 0.95
  device: auto               # cpu|cuda|auto
  prompt_template: "prompts/traffic_sign_following.txt"

topics:
  cmd_vel_base:   /cmd_vel_base
  llm_suggestion: /llm_suggestion
  cmd_vel_final:  /cmd_vel
  odom:           /odom
  sign_det:       /sign_detector/sign

logging:
  rate_hz: 50
  write_csv: true
  out_dir: data/logs
```

Optional QoS profiles in `config/qos.yaml`:

```yaml
qos:
  default:
    reliability: reliable
    history: keep_last
    depth: 10
```

---

## Build & Run

### Build

```bash
cd ros2_ws
colcon build --symlink-install
source install/setup.bash
```

### Run (Simulation / Gazebo)

```bash
ros2 launch llm_nav_bringup sim.launch.py params:=../config/params.yaml
```

### Run (Physical robot)

```bash
ros2 launch llm_nav_bringup real.launch.py params:=../config/params.yaml
```

> **Safety** — The validator always clamps \((v_x,\omega_z)\) to configured bounds and discards late/malformed outputs. The 50 Hz loop never blocks; the fallback path is deterministic and <5 ms.

---

## Nodes overview

### `fsm_nav/node.py`
- **Subscribes**: `/odom`, `/sign_detector/sign`
- **Publishes**: `/cmd_vel_base` (50 Hz)
- **Role**: deterministic FSM (`STRAIGHT`, `TURN_LEFT`, `TURN_RIGHT`, `STOP`) producing safe \((v_x,\omega_z)\).

### `llm_sugg/node.py`
- **Subscribes**: `/odom`, `/sign_detector/sign` (+ prompt context)
- **Publishes**: `/llm_suggestion` (JSON), e.g. `{"vx": 0.22, "wz": 0.35, "mode": "approach", "ts": ...}`
- **Latency**: ~170 ms mean (p95 ~327 ms in our setup); suggestions are **asynchronous** and may be discarded if late.

### `validator_fusion/node.py`
- **Subscribes**: `/cmd_vel_base`, `/llm_suggestion`
- **Publishes**: `/cmd_vel`
- **Validation**: JSON schema check, deadline check, kinematic bounds; optional projection to safe set.
- **Fusion**: 
  \[ v_\mathrm{final} = (1-\alpha)\,v_\mathrm{base} + \alpha\,\Pi_\mathcal{S}(v_\mathrm{llm}) \]
  where \(\Pi_\mathcal{S}\) projects onto the safe set \(\mathcal{S}\).

---

## Data included

- `data/llm_fsm_trials.csv` — per-trial dataset (sim+real; baseline vs LLM)
- `data/aggregate_by_condition.csv` — condition-level aggregates
- `data/stats_summary.csv` — formatted statistical summary
- `data/traj_sim.csv`, `data/traj_real.csv` — 10 Hz trajectories (5×5)
- `figures/traj_sim_overlay.png`, `figures/traj_real_overlay.png` — overlays with **approach** markers (accepted=green, rejected=red)

> Trajectory overlays are strictly within \([0,5]\times[0,5]\). Markers are placed **before** each turn to reflect the “approach” phase.

---

## Analysis & Figures

### Recompute statistics

```bash
python scripts/analyze_stats.py --trials data/llm_fsm_trials.csv --out data/
```

Outputs:
- `data/aggregate_by_condition.csv`
- `data/stats_summary.csv`

Includes Wilson 95% CIs for proportions, t-CIs for means, two-proportion z-test, Welch t-tests, Mann–Whitney, and effect sizes (Cohen’s h, Hedges’ g, RR with CI).

### Generate figures

```bash
python scripts/plot_figures.py \
  --trials data/llm_fsm_trials.csv \
  --traj-sim data/traj_sim.csv \
  --traj-real data/traj_real.csv \
  --out figures/
```

Generates success/error/efficiency/latency plots and both trajectory overlays.

### Regenerate trajectories (optional)

```bash
python scripts/make_trajectories.py --out-csv data/ --out-fig figures/
```

---

## Reproduction (TL;DR)

```bash
# 1) Environment
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

# 2) Build ROS 2
cd ros2_ws && colcon build --symlink-install
source install/setup.bash

# 3) Run (sim or real)
ros2 launch llm_nav_bringup sim.launch.py params:=../config/params.yaml

# 4) Stats & figures
python scripts/analyze_stats.py --trials data/llm_fsm_trials.csv --out data/
python scripts/plot_figures.py --trials data/llm_fsm_trials.csv \
       --traj-sim data/traj_sim.csv --traj-real data/traj_real.csv --out figures/
```

---

## Suggested ablations

- Fusion weight sweep: \(\alpha \in \{0.0, 0.25, 0.5, 0.75, 1.0\}\)
- Output formats: `{vx,wz}` vs. `{v_scale, wz_limit}`
- Kinematic limits sensitivity: \([v_{\min},v_{\max}] \times [\omega_{\min},\omega_{\max}]\)
- LLM runtime profile: mean/p95 latency, deadline-miss %, malformed JSON %, staleness

---

## License

MIT (recommended). Provide your `LICENSE` at the repo root.

---

## Citation

Add to `docs/CITATION.bib` and update DOI/name as needed:

```bibtex
@article{Rojas2025LLMFSM,
  title   = {Plug-and-Play LLM Augmentation of FSM Navigation: Validated Velocity Fusion at 50 Hz Without Fine-Tuning},
  author  = {Rojas, Sebastian},
  journal = {Results in Engineering},
  year    = {2025},
  doi     = {10.XXXX/zenodo.XXXXXXX},
  url     = {https://github.com/<user>/<repo>}
}
```

---

## AI & authorship disclosure

DistilGPT-2 is used **on-device** to generate asynchronous suggestions which are validated before fusion; unsafe or late outputs are rejected. Documentation and analysis were authored by the repository owner; standard grammar/style tools may have been used for minor edits.

---

## Troubleshooting

- **High LLM latency** — reduce `max_new_tokens`, use `device=cuda` if available, or relax `deadline_ms` (without compromising safety).  
- **Yaw oscillation** — lower `alpha`, reduce `w_max`, enable smoothing in the validator.  
- **Frequent invalid suggestions** — refine prompt template and schema checks; strengthen validation thresholds.  
- **Gazebo vs. real gap** — adjust `qos.yaml` and topic reliability for `/odom` and `/cmd_vel*` topics.

---

## Contributing

PRs and issues are welcome. Please follow PEP 8/black formatting, add minimal tests (sim), and use Git LFS for large artifacts (models, heavy CSV/PNG).
