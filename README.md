# ğŸš€ Plug-and-Play LLM Augmentation of FSM Navigation (ROS 2)

**Summary** â€” This repository contains the code and data for a 50â€¯Hz finiteâ€‘state machine (FSM) navigation stack **augmented** with asynchronous, validated **LLM** suggestions (no fineâ€‘tuning), with a deterministic \<5â€¯ms fallback. It ships three ROSÂ 2 nodes (FSM, LLM, Validator/Fusion), perâ€‘trial CSV datasets, analysis scripts, and trajectory figures for a **5Ã—5â€¯m Maze Arena** with â€œapproachâ€ markers: accepted âœ… / rejected âŒ.

---

## ğŸ“ Repository layout

```
.
â”œâ”€ README.md                     # this file
â”œâ”€ LICENSE
â”œâ”€ environment.yml               # optional (conda)
â”œâ”€ requirements.txt              # pip
â”œâ”€ ros2_ws/
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ fsm_nav/
â”‚  â”‚  â”‚  â”œâ”€ fsm_nav/
â”‚  â”‚  â”‚  â”‚  â”œâ”€ __init__.py
â”‚  â”‚  â”‚  â”‚  â””â”€ node.py                 # publishes /cmd_vel_base @ 50 Hz
â”‚  â”‚  â”‚  â”œâ”€ package.xml
â”‚  â”‚  â”‚  â””â”€ setup.py
â”‚  â”‚  â”œâ”€ llm_sugg/
â”‚  â”‚  â”‚  â”œâ”€ llm_sugg/
â”‚  â”‚  â”‚  â”‚  â”œâ”€ __init__.py
â”‚  â”‚  â”‚  â”‚  â””â”€ node.py                 # publishes /llm_suggestion (JSON)
â”‚  â”‚  â”‚  â”œâ”€ package.xml
â”‚  â”‚  â”‚  â””â”€ setup.py
â”‚  â”‚  â”œâ”€ validator_fusion/
â”‚  â”‚  â”‚  â”œâ”€ validator_fusion/
â”‚  â”‚  â”‚  â”‚  â”œâ”€ __init__.py
â”‚  â”‚  â”‚  â”‚  â””â”€ node.py                 # validates & fuses â†’ /cmd_vel
â”‚  â”‚  â”‚  â”œâ”€ package.xml
â”‚  â”‚  â”‚  â””â”€ setup.py
â”‚  â”‚  â””â”€ llm_nav_bringup/
â”‚  â”‚     â”œâ”€ launch/
â”‚  â”‚     â”‚  â”œâ”€ sim.launch.py
â”‚  â”‚     â”‚  â””â”€ real.launch.py
â”‚  â”‚     â””â”€ package.xml
â”‚  â””â”€ install/                          # generated by colcon
â”œâ”€ config/
â”‚  â”œâ”€ params.yaml                       # fusion, limits, deadlines, topics
â”‚  â””â”€ qos.yaml                          # optional QoS profiles
â”œâ”€ data/
â”‚  â”œâ”€ llm_fsm_trials.csv                # per-trial dataset (sim+real, base+llm)
â”‚  â”œâ”€ aggregate_by_condition.csv
â”‚  â”œâ”€ stats_summary.csv
â”‚  â”œâ”€ traj_sim.csv
â”‚  â””â”€ traj_real.csv
â”œâ”€ figures/
â”‚  â”œâ”€ traj_sim_overlay.png              # 5Ã—5 overlays (approach markers)
â”‚  â””â”€ traj_real_overlay.png
â”œâ”€ scripts/
â”‚  â”œâ”€ analyze_stats.py                  # CI, significance tests, effect sizes
â”‚  â”œâ”€ plot_figures.py                   # success/error/efficiency/latency + overlays
â”‚  â”œâ”€ make_trajectories.py              # regenerate 5Ã—5 trajectories & overlays
â”‚  â””â”€ bag_to_csv.py                     # optional rosbag2 â†’ CSV stub
â””â”€ docs/
   â”œâ”€ HOWTO_repro.md
   â””â”€ CITATION.bib
```

> Place the CSVs under `data/` and figures under `figures/` with those exact names so scripts and LaTeX work outâ€‘ofâ€‘theâ€‘box.

---

## ğŸ§° Requirements

- **ROSÂ 2** (Humble recommended), `colcon`, `rclpy`
- **Python â‰¥ 3.9`
- Python deps: `numpy`, `pandas`, `scipy`, `matplotlib`, `pydantic`, `pyyaml`, `transformers`, `torch` (CUDA optional)
- **Hardware (real)**: TurtleBot3 (Burger/Waffle), Intel RealSense D435i
- **GPU (optional)**: Jetson Orin / NVIDIA to accelerate DistilGPTâ€‘2 (not required)

### ğŸ“¦ Install (pip)

```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
```

### ğŸ“¦ Install (conda)

```bash
conda env create -f environment.yml
conda activate llm-fsm
```

---

## âš™ï¸ Configuration

Main settings live in `config/params.yaml`:

```yaml
fusion:
  alpha: 0.5                 # fusion weight (0=FSM only, 1=LLM only)
  v_min: 0.00                # m/s
  v_max: 0.35
  w_min: -1.2                # rad/s
  w_max: 1.2
  deadline_ms: 200           # late suggestions are discarded
  project_safe: true         # clamp to safe set

llm:
  model_name: distilgpt2
  max_new_tokens: 40
  temperature: 0.1
  top_p: 0.95
  device: auto               # cpu|cuda|auto
  prompt_template: "prompts/traffic_sign_following.txt"

topics:
  cmd_vel_base:   /cmd_vel_base
  llm_suggestion: /llm_suggestion
  cmd_vel_final:  /cmd_vel
  odom:           /odom
  sign_det:       /sign_detector/sign

logging:
  rate_hz: 50
  write_csv: true
  out_dir: data/logs
```

Optional QoS profiles in `config/qos.yaml`:

```yaml
qos:
  default:
    reliability: reliable
    history: keep_last
    depth: 10
```

---

## ğŸ—ï¸ Build & â–¶ï¸ Run

### ğŸ› ï¸ Build

```bash
cd ros2_ws
colcon build --symlink-install
source install/setup.bash
```

### ğŸ§ª Run (Simulation / Gazebo)

```bash
ros2 launch llm_nav_bringup sim.launch.py params:=../config/params.yaml
```

### ğŸ¤– Run (Physical robot)

```bash
ros2 launch llm_nav_bringup real.launch.py params:=../config/params.yaml
```

> **ğŸ”’ Safety** â€” The validator always clamps \((v_x,\omega_z)\) to configured bounds and discards late/malformed outputs. The 50â€¯Hz loop never blocks; the fallback path is deterministic and \<5â€¯ms.

---

## ğŸ§© Nodes overview

### ğŸ§­ `fsm_nav/node.py`
- **Subscribes**: `/odom`, `/sign_detector/sign`
- **Publishes**: `/cmd_vel_base` (50â€¯Hz)
- **Role**: deterministic FSM (`STRAIGHT`, `TURN_LEFT`, `TURN_RIGHT`, `STOP`) producing safe \((v_x,\omega_z)\).

### ğŸ§  `llm_sugg/node.py`
- **Subscribes**: `/odom`, `/sign_detector/sign` (+ prompt context)
- **Publishes**: `/llm_suggestion` (JSON), e.g. `{"vx": 0.22, "wz": 0.35, "mode": "approach", "ts": ...}`
- **Latency**: ~170â€¯ms mean (p95 ~327â€¯ms in our setup); suggestions are **asynchronous** and may be discarded if late.

### ğŸ›¡ï¸ `validator_fusion/node.py`
- **Subscribes**: `/cmd_vel_base`, `/llm_suggestion`
- **Publishes**: `/cmd_vel`
- **Validation**: JSON schema check, deadline check, kinematic bounds; optional projection to safe set.
- **Fusion**: 
  \[ v_\mathrm{final} = (1-\alpha)\,v_\mathrm{base} + \alpha\,\Pi_\mathcal{S}(v_\mathrm{llm}) \]
  where \(\Pi_\mathcal{S}\) projects onto the safe set \(\mathcal{S}\).

---

## ğŸ“Š Data included

- `data/llm_fsm_trials.csv` â€” perâ€‘trial dataset (sim+real; baseline vs LLM)
- `data/aggregate_by_condition.csv` â€” conditionâ€‘level aggregates
- `data/stats_summary.csv` â€” formatted statistical summary
- `data/traj_sim.csv`, `data/traj_real.csv` â€” 10â€¯Hz trajectories (5Ã—5)
- `figures/traj_sim_overlay.png`, `figures/traj_real_overlay.png` â€” overlays with **approach** markers (accepted=ğŸŸ¢, rejected=ğŸ”´)

> Trajectory overlays are strictly within \([0,5]\times[0,5]\). Markers are placed **before** each turn to reflect the **approach** phase.

---

## ğŸ“ˆ Analysis & Figures

### ğŸ”¬ Recompute statistics

```bash
python scripts/analyze_stats.py --trials data/llm_fsm_trials.csv --out data/
```

Outputs:
- `data/aggregate_by_condition.csv`
- `data/stats_summary.csv`

Includes Wilson 95% CIs for proportions, tâ€‘CIs for means, twoâ€‘proportion zâ€‘test, Welch tâ€‘tests, Mannâ€“Whitney, and effect sizes (Cohenâ€™s h, Hedgesâ€™ g, RR with CI).

### ğŸ–¼ï¸ Generate figures

```bash
python scripts/plot_figures.py \
  --trials data/llm_fsm_trials.csv \
  --traj-sim data/traj_sim.csv \
  --traj-real data/traj_real.csv \
  --out figures/
```

Generates success/error/efficiency/latency plots and both trajectory overlays.

### ğŸ” Regenerate trajectories (optional)

```bash
python scripts/make_trajectories.py --out-csv data/ --out-fig figures/
```

---

## â±ï¸ Reproduction (TL;DR)

```bash
# 1) Environment
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

# 2) Build ROS 2
cd ros2_ws && colcon build --symlink-install
source install/setup.bash

# 3) Run (sim or real)
ros2 launch llm_nav_bringup sim.launch.py params:=../config/params.yaml

# 4) Stats & figures
python scripts/analyze_stats.py --trials data/llm_fsm_trials.csv --out data/
python scripts/plot_figures.py --trials data/llm_fsm_trials.csv \
       --traj-sim data/traj_sim.csv --traj-real data/traj_real.csv --out figures/
```

---

## ğŸ§ª Suggested ablations

- Fusion weight sweep: \(\alpha \in \{0.0, 0.25, 0.5, 0.75, 1.0\}\)
- Output formats: `{vx,wz}` vs. `{v_scale, wz_limit}`
- Kinematic limits sensitivity: \([v_{\min},v_{\max}] \times [\omega_{\min},\omega_{\max}]\)
- LLM runtime profile: mean/p95 latency, deadlineâ€‘missÂ %, malformed JSONÂ %, staleness

---

## âš–ï¸ License

MIT (recommended). Provide your `LICENSE` at the repo root.


---

## ğŸ¤–ğŸ’¬ AI & authorship disclosure

DistilGPTâ€‘2 is used **onâ€‘device** to generate asynchronous suggestions which are validated before fusion; unsafe or late outputs are rejected. Documentation and analysis were authored by the repository owner; standard grammar/style tools may have been used for minor edits.

---

## ğŸ› ï¸ Troubleshooting

- **High LLM latency** â€” reduce `max_new_tokens`, use `device=cuda` if available, or relax `deadline_ms` (without compromising safety).  
- **Yaw oscillation** â€” lower `alpha`, reduce `w_max`, enable smoothing in the validator.  
- **Frequent invalid suggestions** â€” refine prompt template and schema checks; strengthen validation thresholds.  
- **Gazebo vs real gap** â€” adjust `qos.yaml` and topic reliability for `/odom` and `/cmd_vel*` topics.

---

## ğŸ¤ Contributing

PRs and issues are welcome. Please follow PEPÂ 8/black formatting, add minimal tests (sim), and use GitÂ LFS for large artifacts (models, heavy CSV/PNG).


## Contributing

PRs and issues are welcome. Please follow PEP 8/black formatting, add minimal tests (sim), and use Git LFS for large artifacts (models, heavy CSV/PNG).
